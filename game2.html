<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SkyRider</title>
<style>
*{margin:0;padding:0}
body{overflow:hidden;background:#000;touch-action:none;-webkit-user-select:none;user-select:none}
canvas{position:absolute;top:0;left:0;width:100%;height:100%}
#h{z-index:1;pointer-events:none}
#m{z-index:2;position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;font-family:sans-serif;text-align:center;background:rgba(0,0,0,.45)}
#m h1{font-size:2.8em;margin-bottom:.1em;text-shadow:0 0 30px #f80,0 0 60px #f40;letter-spacing:2px}
#m p{font-size:1.15em;opacity:.8}
#m .s{font-size:2em;color:#fd0;margin:.2em 0}
#m .sub{font-size:.9em;opacity:.4;margin-top:1.2em}
</style>
</head>
<body>
<canvas id="g"></canvas>
<canvas id="h"></canvas>
<div id="m"><h1>SKYRIDER</h1><p>Tap &amp; hold to fly<br>Drag to steer</p><p class="sub">Destroy balloons to score</p></div>
<script>
"use strict";
var G=document.getElementById('g'),H=document.getElementById('h'),M=document.getElementById('m');
var gl=G.getContext('webgl',{antialias:false,alpha:false});
var hc=H.getContext('2d');
var W,Ht;

function resize(){
W=innerWidth;Ht=innerHeight;
G.width=H.width=W;G.height=H.height=Ht;
gl.viewport(0,0,W,Ht);
}
resize();addEventListener('resize',resize);

// === TERRAIN SHADER ===
var VS=`
precision mediump float;
attribute vec3 aP;
attribute vec3 aC;
attribute vec3 aN;
uniform mat4 uVP;
uniform vec3 uCam;
uniform float uTime;
varying vec3 vC;
varying vec3 vN;
varying vec3 vPos;
varying float vF;
void main(){
vec3 pos=aP;
float isWater=step(0.5,aC.b)*step(aC.r,0.25);
pos.y+=isWater*(sin(pos.x*0.1+uTime*2.0)*0.8+cos(pos.z*0.13+uTime*1.5)*0.6);
gl_Position=uVP*vec4(pos,1.0);
float d=length(pos.xz-uCam.xz);
vF=clamp(d/320.0,0.0,1.0);
vC=aC;
vN=aN;
vPos=pos;
}`;

var FS=`
precision mediump float;
varying vec3 vC;
varying vec3 vN;
varying vec3 vPos;
varying float vF;
uniform vec3 uSky;
uniform vec3 uCam;
uniform float uTime;
float hn(vec2 p){p=fract(p*vec2(.1031,.103));p+=dot(p,p.yx+33.33);return fract((p.x+p.y)*p.x);}
void main(){
vec3 sunDir=normalize(vec3(0.4,0.6,0.3));
vec3 sunCol=vec3(1.0,0.92,0.75);
vec3 V=normalize(uCam-vPos);
vec3 hv=normalize(sunDir+V);
float NdL=max(dot(vN,sunDir),0.0);
vec3 ambUp=vec3(0.4,0.5,0.65);
vec3 ambDn=vec3(0.25,0.2,0.15);
vec3 amb=mix(ambDn,ambUp,dot(vN,vec3(0.0,1.0,0.0))*0.5+0.5);
float nv=hn(vPos.xz*0.5)*0.08-0.04;
vec3 bc=vC+vec3(nv);
vec3 col=bc*(amb+sunCol*0.7*NdL);
float ao=clamp(vPos.y/80.0+0.4,0.45,1.0);
col*=ao;
float slope=1.0-vN.y;
col*=1.0-slope*slope*0.25;
float cloud=sin(vPos.x*0.015+uTime*0.4)*sin(vPos.z*0.018-uTime*0.3);
col*=0.82+0.18*smoothstep(-0.2,0.3,cloud);
float isWater=step(0.5,vC.b)*step(vC.r,0.25);
float spec=pow(max(dot(vN,hv),0.0),64.0);
col+=sunCol*spec*1.0*isWater;
float caust=sin(vPos.x*0.8+uTime*1.5)*sin(vPos.z*0.7-uTime*1.2)*0.5+0.5;
col+=vec3(0.04,0.1,0.16)*caust*isWater;
float fres=pow(1.0-max(dot(V,vN),0.0),4.0);
col=mix(col,mix(col,uSky*1.2,fres*0.5),isWater);
float isSnow=step(0.85,vC.r)*step(0.85,vC.g);
float sspec=pow(max(dot(vN,hv),0.0),32.0);
col+=sunCol*sspec*0.5*isSnow;
float isGrass=step(0.15,vC.g)*step(vC.r,0.5)*(1.0-isWater)*(1.0-isSnow);
float sss=max(dot(-V,sunDir),0.0)*0.12;
col+=vec3(0.08,0.15,0.02)*sss*isGrass;
float ht=clamp(vPos.y*0.01,0.0,1.0);
vec3 fogNr=mix(vec3(0.88,0.78,0.58),uSky,ht);
vec3 fogFr=mix(vec3(0.9,0.8,0.6),vec3(0.7,0.8,0.92),ht);
vec3 fogCol=mix(fogNr,fogFr,vF);
float f=1.0-exp(-vF*vF*3.5);
col=mix(col,fogCol,f);
gl_FragColor=vec4(col,1.0);
}`;

// === SKY SHADER ===
var SKVS=`
precision mediump float;
attribute vec2 aPos;
varying vec2 vUV;
void main(){
gl_Position=vec4(aPos,0.999,1.0);
vUV=aPos*0.5+0.5;
}`;
var SKFS=`
precision mediump float;
varying vec2 vUV;
void main(){
vec3 top=vec3(0.22,0.42,0.82);
vec3 mid=vec3(0.45,0.65,0.92);
vec3 hor=vec3(0.92,0.78,0.55);
float t=vUV.y;
vec3 col=mix(hor,mid,smoothstep(0.0,0.45,t));
col=mix(col,top,smoothstep(0.35,0.95,t));
vec2 sp=vec2(0.65,0.22);
float sd=length(vUV-sp);
col+=vec3(1.0,0.92,0.65)*0.5*exp(-sd*7.0);
col+=vec3(1.0,0.95,0.8)*0.2*exp(-sd*2.5);
gl_FragColor=vec4(col,1.0);
}`;

// === RING SHADER ===
var RVS=`
precision mediump float;
attribute vec3 aP;
attribute vec3 aRN;
uniform mat4 uVP;
uniform vec3 uCam;
varying float vF;
varying vec3 vRN;
varying vec3 vRP;
void main(){
gl_Position=uVP*vec4(aP,1.0);
vF=clamp(length(aP.xz-uCam.xz)/320.0,0.0,1.0);
vRN=aRN;
vRP=aP;
}`;

var RFS=`
precision mediump float;
varying float vF;
varying vec3 vRN;
varying vec3 vRP;
uniform vec3 uSky;
uniform vec3 uCol;
uniform vec3 uCam;
void main(){
vec3 V=normalize(uCam-vRP);
vec3 L=normalize(vec3(0.3,0.8,0.2));
float diff=0.5+0.5*max(dot(vRN,L),0.0);
float rim=pow(1.0-max(dot(V,vRN),0.0),2.5);
vec3 col=uCol*diff+uCol*rim*0.6+vec3(1.0,0.95,0.8)*rim*0.3;
vec3 fogCol=mix(uSky,vec3(0.95,0.75,0.5),vF*0.4);
col=mix(col,fogCol,vF*vF);
gl_FragColor=vec4(col,1.0);
}`;

function mkS(s,t){
var o=gl.createShader(t);
gl.shaderSource(o,s);
gl.compileShader(o);
if(!gl.getShaderParameter(o,gl.COMPILE_STATUS))console.error('Shader:',gl.getShaderInfoLog(o));
return o;
}
function mkP(v,f){
var p=gl.createProgram();
gl.attachShader(p,mkS(v,gl.VERTEX_SHADER));
gl.attachShader(p,mkS(f,gl.FRAGMENT_SHADER));
gl.linkProgram(p);
if(!gl.getProgramParameter(p,gl.LINK_STATUS))console.error('Link:',gl.getProgramInfoLog(p));
return p;
}

var prog=mkP(VS,FS),rProg=mkP(RVS,RFS);
var uVP=gl.getUniformLocation(prog,'uVP');
var uCam=gl.getUniformLocation(prog,'uCam');
var uSky=gl.getUniformLocation(prog,'uSky');
var uTime=gl.getUniformLocation(prog,'uTime');
var lP=gl.getAttribLocation(prog,'aP');
var lC=gl.getAttribLocation(prog,'aC');
var lN=gl.getAttribLocation(prog,'aN');

var ruVP=gl.getUniformLocation(rProg,'uVP');
var ruCam=gl.getUniformLocation(rProg,'uCam');
var ruSky=gl.getUniformLocation(rProg,'uSky');
var ruCol=gl.getUniformLocation(rProg,'uCol');
var rlP=gl.getAttribLocation(rProg,'aP');
var rlN=gl.getAttribLocation(rProg,'aRN');

var skProg=mkP(SKVS,SKFS);
var skAP=gl.getAttribLocation(skProg,'aPos');
var skBuf=gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER,skBuf);
gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,3,-1,-1,3]),gl.STATIC_DRAW);

gl.enable(gl.DEPTH_TEST);

// === NOISE ===
function hash(x,y){
var n=(x*374761393+y*668265263)|0;
n=Math.imul(n^(n>>>13),1274126177);
return((n^(n>>>16))>>>0)/4294967296;
}
function noise(x,y){
var ix=Math.floor(x),iy=Math.floor(y);
var fx=x-ix,fy=y-iy;
var sx=fx*fx*(3-2*fx),sy=fy*fy*(3-2*fy);
var a=hash(ix,iy),b=hash(ix+1,iy),c=hash(ix,iy+1),d=hash(ix+1,iy+1);
return a+(b-a)*sx+(c-a)*sy+(d-a-c+a+b-d)*sx*sy;
}
function fbm(x,y,oct){
var v=0,a=1,f=1,t=0;
for(var i=0;i<oct;i++){v+=noise(x*f,y*f)*a;t+=a;a*=.5;f*=2;}
return v/t;
}
function ter(x,z){
var s=0.007;
var h=fbm(x*s,z*s,4)*130-25;
var r=fbm(x*s*0.5+99,z*s*0.5+99,2);
if(r>0.58)h*=1+(r-0.58)*4;
if(h>25){var rn=(1-Math.abs(noise(x*s*3,z*s*3)*2-1))*(1-Math.abs(noise(x*s*6+5,z*s*6+5)*2-1));
h+=rn*22*Math.min(1,(h-25)/50);}
return h;
}

// === TERRAIN MESH ===
var GS=50,SP=7,triCount=GS*GS*6;
var tData=new Float32Array(triCount*9);
var tBuf=gl.createBuffer();
var G1=GS+1,hg=new Float32Array(G1*G1),ng=new Float32Array(G1*G1*3),cg=new Float32Array(G1*G1*3);

function hCol(h,sl){
var B=[[-15,.06,.18,.48],[-6,.1,.28,.55],[-1,.18,.38,.58],[2,.78,.7,.48],[10,.4,.65,.2],[25,.3,.55,.16],[42,.22,.45,.12],[60,.16,.35,.09],[76,.52,.42,.28],[90,.58,.52,.4],[110,.92,.92,.95]];
for(var i=0;i<B.length-1;i++){if(h<B[i+1][0]){
var t=Math.max(0,Math.min(1,(h-B[i][0])/(B[i+1][0]-B[i][0])));t=t*t*(3-2*t);
var r=B[i][1]+(B[i+1][1]-B[i][1])*t,g=B[i][2]+(B[i+1][2]-B[i][2])*t,b=B[i][3]+(B[i+1][3]-B[i][3])*t;
if(sl>0.4&&h>5&&h<85){var st=Math.min(1,(sl-0.4)/0.3);
r+=(0.52-r)*st;g+=(0.43-g)*st;b+=(0.32-b)*st;}
return[r,g,b];}}
return[.92,.92,.95];
}

function buildTerrain(cx,cz){
var vi=0,half=GS*SP/2;
var ox=Math.floor(cx/SP)*SP-half;
var oz=Math.floor(cz/SP)*SP-half;
// Height grid (each vertex computed once)
for(var j=0;j<=GS;j++)for(var i=0;i<=GS;i++)hg[j*G1+i]=ter(ox+i*SP,oz+j*SP);
// Smooth normals from central differences
for(var j=0;j<=GS;j++)for(var i=0;i<=GS;i++){
var hL=i>0?hg[j*G1+i-1]:hg[j*G1+i],hR=i<GS?hg[j*G1+i+1]:hg[j*G1+i];
var hD=j>0?hg[(j-1)*G1+i]:hg[j*G1+i],hU=j<GS?hg[(j+1)*G1+i]:hg[j*G1+i];
var dx=i>0&&i<GS?2*SP:SP,dz=j>0&&j<GS?2*SP:SP;
var nx=(hL-hR)/dx,nz=(hD-hU)/dz,ny=1;
var nl=1/Math.sqrt(nx*nx+ny*ny+nz*nz);var k=(j*G1+i)*3;
ng[k]=nx*nl;ng[k+1]=ny*nl;ng[k+2]=nz*nl;
}
// Per-vertex colors (slope-aware)
for(var j=0;j<=GS;j++)for(var i=0;i<=GS;i++){
var k=(j*G1+i)*3;var c=hCol(hg[j*G1+i],1-ng[k+1]);
cg[k]=c[0];cg[k+1]=c[1];cg[k+2]=c[2];
}
// Build triangles with smooth normals + per-vertex color
function ev(x,y,z,k){
tData[vi++]=x;tData[vi++]=y;tData[vi++]=z;
tData[vi++]=cg[k];tData[vi++]=cg[k+1];tData[vi++]=cg[k+2];
tData[vi++]=ng[k];tData[vi++]=ng[k+1];tData[vi++]=ng[k+2];
}
for(var j=0;j<GS;j++){for(var i=0;i<GS;i++){
var x=ox+i*SP,z=oz+j*SP;
var i00=j*G1+i,i10=j*G1+i+1,i01=(j+1)*G1+i,i11=(j+1)*G1+i+1;
ev(x,hg[i00],z,i00*3);ev(x+SP,hg[i10],z,i10*3);ev(x,hg[i01],z+SP,i01*3);
ev(x+SP,hg[i10],z,i10*3);ev(x+SP,hg[i11],z+SP,i11*3);ev(x,hg[i01],z+SP,i01*3);
}}
gl.bindBuffer(gl.ARRAY_BUFFER,tBuf);
gl.bufferData(gl.ARRAY_BUFFER,tData,gl.DYNAMIC_DRAW);
}

// === MATRIX MATH ===
function perspective(fov,asp,n,f){
var t=1/Math.tan(fov/2),r=1/(n-f);
return new Float32Array([t/asp,0,0,0,0,t,0,0,0,0,(f+n)*r,-1,0,0,2*f*n*r,0]);
}
function mulM(a,b){
var o=new Float32Array(16);
for(var i=0;i<4;i++)for(var j=0;j<4;j++)
o[j*4+i]=a[i]*b[j*4]+a[4+i]*b[j*4+1]+a[8+i]*b[j*4+2]+a[12+i]*b[j*4+3];
return o;
}
function lookAtMat(ex,ey,ez,tx,ty,tz,rl){
var fx=tx-ex,fy=ty-ey,fz=tz-ez;
var fl=1/Math.sqrt(fx*fx+fy*fy+fz*fz);
fx*=fl;fy*=fl;fz*=fl;
var rx=-fz,ry=0,rz=fx;
var rlen=1/Math.sqrt(rx*rx+rz*rz+.0001);
rx*=rlen;rz*=rlen;
var ux=ry*fz-rz*fy,uy=rz*fx-rx*fz,uz=rx*fy-ry*fx;
if(rl){
var cr=Math.cos(rl),sr=Math.sin(rl);
var rx2=rx*cr+ux*sr,ry2=ry*cr+uy*sr,rz2=rz*cr+uz*sr;
var ux2=-rx*sr+ux*cr,uy2=-ry*sr+uy*cr,uz2=-rz*sr+uz*cr;
rx=rx2;ry=ry2;rz=rz2;ux=ux2;uy=uy2;uz=uz2;
}
return new Float32Array([
rx,ux,-fx,0,ry,uy,-fy,0,rz,uz,-fz,0,
-(rx*ex+ry*ey+rz*ez),-(ux*ex+uy*ey+uz*ez),fx*ex+fy*ey+fz*ez,1
]);
}

// === PLANE MESH ===
// Local space: nose=-Z, up=+Y, right=+X
var plTris=[
// Body top-left
0,.4,-4, -.5,0,.8, 0,.15,3,
// Body top-right
0,.4,-4, 0,.15,3, .5,0,.8,
// Body bot-left
0,-.2,-4, 0,-.1,3, -.5,0,.8,
// Body bot-right
0,-.2,-4, .5,0,.8, 0,-.1,3,
// Body left
0,.4,-4, -.5,0,.8, 0,-.2,-4,
// Body right
0,.4,-4, 0,-.2,-4, .5,0,.8,
// Left wing
-.5,0,-.3, -6,.2,.8, -.5,0,2,
// Right wing
.5,0,-.3, .5,0,2, 6,.2,.8,
// Tail fin
0,.15,2, 0,2.2,3.2, 0,.15,3.5,
// Left stabilizer
0,.15,2.5, -2.2,.25,3.5, 0,.15,3.5,
// Right stabilizer
0,.15,2.5, 0,.15,3.5, 2.2,.25,3.5
];
// Build local verts with flat normals (pos+norm interleaved)
var plLocal=[];
for(var pi=0;pi<plTris.length;pi+=9){
var ax=plTris[pi],ay=plTris[pi+1],az=plTris[pi+2];
var bx=plTris[pi+3],by=plTris[pi+4],bz=plTris[pi+5];
var cx=plTris[pi+6],cy=plTris[pi+7],cz=plTris[pi+8];
var eux=bx-ax,euy=by-ay,euz=bz-az,evx=cx-ax,evy=cy-ay,evz=cz-az;
var enx=euy*evz-euz*evy,eny=euz*evx-eux*evz,enz=eux*evy-euy*evx;
var enl=1/Math.sqrt(enx*enx+eny*eny+enz*enz+.001);
enx*=enl;eny*=enl;enz*=enl;
plLocal.push(ax,ay,az,enx,eny,enz, bx,by,bz,enx,eny,enz, cx,cy,cz,enx,eny,enz);
}
var plCount=plLocal.length/6;
var plWorld=new Float32Array(plLocal.length);
var plBuf=gl.createBuffer();

function updatePlane(ppx,ppy,ppz,pi,ya,ro){
var cp=Math.cos(pi),sp=Math.sin(pi),cy=Math.cos(ya),sy=Math.sin(ya);
var cr=Math.cos(ro),sr=Math.sin(ro);
// Rotation = Ry(yaw) * Rx(pitch) * Rz(roll)
var m00=cy*cr+sy*sp*sr, m01=-cy*sr+sy*sp*cr, m02=sy*cp;
var m10=cp*sr,           m11=cp*cr,            m12=-sp;
var m20=-sy*cr+cy*sp*sr, m21=sy*sr+cy*sp*cr,   m22=cy*cp;
for(var i=0;i<plLocal.length;i+=6){
var lx=plLocal[i],ly=plLocal[i+1],lz=plLocal[i+2];
plWorld[i]=m00*lx+m01*ly+m02*lz+ppx;
plWorld[i+1]=m10*lx+m11*ly+m12*lz+ppy;
plWorld[i+2]=m20*lx+m21*ly+m22*lz+ppz;
var nx=plLocal[i+3],ny=plLocal[i+4],nz=plLocal[i+5];
plWorld[i+3]=m00*nx+m01*ny+m02*nz;
plWorld[i+4]=m10*nx+m11*ny+m12*nz;
plWorld[i+5]=m20*nx+m21*ny+m22*nz;
}
gl.bindBuffer(gl.ARRAY_BUFFER,plBuf);
gl.bufferData(gl.ARRAY_BUFFER,plWorld,gl.DYNAMIC_DRAW);
}

// === HELPER: flat-shaded triangle ===
function addTri(v,a,b,c){
var ux=b[0]-a[0],uy=b[1]-a[1],uz=b[2]-a[2];
var vx=c[0]-a[0],vy=c[1]-a[1],vz=c[2]-a[2];
var nx=uy*vz-uz*vy,ny=uz*vx-ux*vz,nz=ux*vy-uy*vx;
var nl=1/Math.sqrt(nx*nx+ny*ny+nz*nz+.001);
nx*=nl;ny*=nl;nz*=nl;
v.push(a[0],a[1],a[2],nx,ny,nz,b[0],b[1],b[2],nx,ny,nz,c[0],c[1],c[2],nx,ny,nz);
}

// === BALLOON MESH ===
function mkBal(bx,by,bz){
var v=[],seg=12;
// Hot air balloon profile: [height_offset, radius]
var prof=[[-1,1.8],[1,4.0],[3,5.2],[5,5.0],[7,4.0],[9,2.0],[10.5,0]];
for(var si=0;si<seg;si++){
var a0=si/seg*6.2832,a1=(si+1)/seg*6.2832;
var c0=Math.cos(a0),s0=Math.sin(a0),c1=Math.cos(a1),s1=Math.sin(a1);
for(var pi=0;pi<prof.length-1;pi++){
var r0=prof[pi][1],y0=by+prof[pi][0],r1=prof[pi+1][1],y1=by+prof[pi+1][0];
addTri(v,[bx+r0*c0,y0,bz+r0*s0],[bx+r0*c1,y0,bz+r0*s1],[bx+r1*c0,y1,bz+r1*s0]);
addTri(v,[bx+r1*c0,y1,bz+r1*s0],[bx+r0*c1,y0,bz+r0*s1],[bx+r1*c1,y1,bz+r1*s1]);
}}
// Basket with 4 sides
var bs=1.3,bby=by-5,bth=bby+2;
var bcs=[[bx-bs,bz-bs],[bx+bs,bz-bs],[bx+bs,bz+bs],[bx-bs,bz+bs]];
for(var bi=0;bi<4;bi++){var bn=(bi+1)%4;
addTri(v,[bcs[bi][0],bby,bcs[bi][1]],[bcs[bn][0],bby,bcs[bn][1]],[bcs[bn][0],bth,bcs[bn][1]]);
addTri(v,[bcs[bi][0],bby,bcs[bi][1]],[bcs[bn][0],bth,bcs[bn][1]],[bcs[bi][0],bth,bcs[bi][1]]);
}
// Ropes from basket corners to envelope skirt
var rw=0.1;
for(var ri=0;ri<4;ri++){
var rdx=bcs[ri][0]-bx,rdz=bcs[ri][1]-bz;
var rdl=1/Math.sqrt(rdx*rdx+rdz*rdz+.001);
addTri(v,[bcs[ri][0],bth,bcs[ri][1]],[bcs[ri][0]+rw,bth,bcs[ri][1]+rw],[bx+rdx*rdl*1.5,by-1,bz+rdz*rdl*1.5]);
}
var buf=gl.createBuffer(),arr=new Float32Array(v);
gl.bindBuffer(gl.ARRAY_BUFFER,buf);
gl.bufferData(gl.ARRAY_BUFFER,arr,gl.STATIC_DRAW);
return{buf:buf,cnt:arr.length/6};
}

// === PROJECTILE MESH (octahedron, local space) ===
var pjL=[],pjR=0.6;
var pjV=[[0,pjR,0],[pjR,0,0],[0,0,pjR],[-pjR,0,0],[0,0,-pjR],[0,-pjR,0]];
var pjF=[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[5,2,1],[5,3,2],[5,4,3],[5,1,4]];
for(var qi=0;qi<pjF.length;qi++){var qf=pjF[qi];addTri(pjL,pjV[qf[0]],pjV[qf[1]],pjV[qf[2]]);}
var pjVPP=pjL.length/6;
var MAXPJ=40,pjBuf=gl.createBuffer(),pjArr=new Float32Array(MAXPJ*pjL.length);
function buildProjBuf(){
var n=Math.min(projs.length,MAXPJ);
for(var i=0;i<n;i++){var p=projs[i],off=i*pjL.length;
for(var j=0;j<pjL.length;j+=6){
pjArr[off+j]=pjL[j]+p.x;pjArr[off+j+1]=pjL[j+1]+p.y;pjArr[off+j+2]=pjL[j+2]+p.z;
pjArr[off+j+3]=pjL[j+3];pjArr[off+j+4]=pjL[j+4];pjArr[off+j+5]=pjL[j+5];
}}
gl.bindBuffer(gl.ARRAY_BUFFER,pjBuf);
gl.bufferData(gl.ARRAY_BUFFER,pjArr.subarray(0,n*pjL.length),gl.DYNAMIC_DRAW);
return n*pjVPP;
}

// === PLAYER PROJECTILE BUFFER ===
var MAXPP=20,ppBuf=gl.createBuffer(),ppArr=new Float32Array(MAXPP*pjL.length);
function buildPPBuf(){
var n=Math.min(pProjs.length,MAXPP);
for(var i=0;i<n;i++){var p=pProjs[i],off=i*pjL.length;
for(var j=0;j<pjL.length;j+=6){
ppArr[off+j]=pjL[j]+p.x;ppArr[off+j+1]=pjL[j+1]+p.y;ppArr[off+j+2]=pjL[j+2]+p.z;
ppArr[off+j+3]=pjL[j+3];ppArr[off+j+4]=pjL[j+4];ppArr[off+j+5]=pjL[j+5];
}}
gl.bindBuffer(gl.ARRAY_BUFFER,ppBuf);
gl.bufferData(gl.ARRAY_BUFFER,ppArr.subarray(0,n*pjL.length),gl.DYNAMIC_DRAW);
return n*pjVPP;
}

// === GAME STATE ===
var state=0,px=0,py=80,pz=0;
var pitch=0,yaw=0,roll=0;
var speed=40,score=0,dist=0,streak=0,mult=1;
var touchX=0,touchY=0,touching=false;
var lastT=0,crashT=0,gameTime=0;
var camX=0,camY=88,camZ=22;
var collectFlash=0;
var bestScore=0;
var shakeX=0,shakeY=0;
var hp=3,invT=0;
var bals=[],projs=[];
var pProjs=[],shootCD=0,aimTarget=-1;
var BCOUNT=7;
var bCols=[[.9,.15,.1],[.2,.35,.85],[.1,.7,.25],[.85,.5,.9],[.95,.6,.1]];

function spawnBal(){
var ang=yaw+(Math.random()-0.5)*1.0;
var d=100+Math.random()*180;
var bx=px-Math.sin(ang)*d;
var bz=pz-Math.cos(ang)*d;
var th=ter(bx,bz);
var by=Math.max(th+15,35)+Math.random()*30;
var ci=Math.floor(Math.random()*bCols.length);
bals.push({x:bx,y:by,z:bz,m:mkBal(bx,by,bz),st:1.5+Math.random()*2,c:bCols[ci]});
}
function initBals(){
bals.forEach(function(b){gl.deleteBuffer(b.m.buf);});
bals=[];projs=[];
}

// === AUDIO ===
var ac,eG,wG,mG,eo1,eo2;
function initAudio(){
try{
ac=new(window.AudioContext||window.webkitAudioContext)();
mG=ac.createGain();mG.gain.value=0.3;mG.connect(ac.destination);
eG=ac.createGain();eG.gain.value=0.1;eG.connect(mG);
eo1=ac.createOscillator();eo1.type='sawtooth';eo1.frequency.value=75;eo1.connect(eG);eo1.start();
eo2=ac.createOscillator();eo2.type='triangle';eo2.frequency.value=113;eo2.connect(eG);eo2.start();
var bs=ac.sampleRate*2,ab=ac.createBuffer(1,bs,ac.sampleRate),ch=ab.getChannelData(0);
for(var i=0;i<bs;i++)ch[i]=Math.random()*2-1;
var wn=ac.createBufferSource();wn.buffer=ab;wn.loop=true;
wG=ac.createGain();wG.gain.value=0.03;
wn.connect(wG);wG.connect(mG);wn.start();
}catch(e){}
}
function sfxCrash(){
if(!ac)return;
var bs=ac.sampleRate,ab=ac.createBuffer(1,bs,ac.sampleRate),ch=ab.getChannelData(0);
for(var i=0;i<bs;i++)ch[i]=(Math.random()*2-1)*Math.exp(-i/bs*3);
var s=ac.createBufferSource();s.buffer=ab;
var g=ac.createGain();g.gain.value=0.5;s.connect(g);g.connect(mG);s.start();
// Low boom
var o=ac.createOscillator(),g2=ac.createGain(),t=ac.currentTime;
o.type='sine';o.frequency.setValueAtTime(80,t);o.frequency.exponentialRampToValueAtTime(20,t+0.5);
g2.gain.setValueAtTime(0.4,t);g2.gain.exponentialRampToValueAtTime(0.001,t+0.6);
o.connect(g2);g2.connect(mG);o.start(t);o.stop(t+0.6);
}
function sfxWarn(){
if(!ac)return;
var o=ac.createOscillator(),g=ac.createGain(),t=ac.currentTime;
o.type='square';o.frequency.value=440;
g.gain.setValueAtTime(0.08,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.1);
o.connect(g);g.connect(mG);o.start(t);o.stop(t+0.1);
}
function sfxShoot(){
if(!ac)return;
var o=ac.createOscillator(),g=ac.createGain(),t=ac.currentTime;
o.type='sawtooth';o.frequency.setValueAtTime(220,t);o.frequency.exponentialRampToValueAtTime(60,t+0.15);
g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.2);
o.connect(g);g.connect(mG);o.start(t);o.stop(t+0.2);
}
function sfxHit(){
if(!ac)return;var t=ac.currentTime;
var o=ac.createOscillator(),g=ac.createGain();
o.type='square';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(80,t+0.2);
g.gain.setValueAtTime(0.25,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.3);
o.connect(g);g.connect(mG);o.start(t);o.stop(t+0.3);
}
function sfxPShoot(){
if(!ac)return;var t=ac.currentTime;
var o=ac.createOscillator(),g=ac.createGain();
o.type='sine';o.frequency.setValueAtTime(880,t);o.frequency.exponentialRampToValueAtTime(440,t+0.08);
g.gain.setValueAtTime(0.12,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.12);
o.connect(g);g.connect(mG);o.start(t);o.stop(t+0.12);
}
function sfxBoom(){
if(!ac)return;var t=ac.currentTime;
var bs=ac.sampleRate/2,ab=ac.createBuffer(1,bs,ac.sampleRate),ch=ab.getChannelData(0);
for(var i=0;i<bs;i++)ch[i]=(Math.random()*2-1)*Math.exp(-i/bs*4);
var s=ac.createBufferSource();s.buffer=ab;
var g=ac.createGain();g.gain.value=0.35;s.connect(g);g.connect(mG);s.start();
var o=ac.createOscillator(),g2=ac.createGain();
o.type='sine';o.frequency.setValueAtTime(120,t);o.frequency.exponentialRampToValueAtTime(30,t+0.3);
g2.gain.setValueAtTime(0.3,t);g2.gain.exponentialRampToValueAtTime(0.001,t+0.4);
o.connect(g2);g2.connect(mG);o.start(t);o.stop(t+0.4);
}

// === TOUCH ===
function tpos(e){var t=e.touches?e.touches[0]:e;return{x:t.clientX,y:t.clientY};}
function onD(e){
e.preventDefault();
if(state===0){state=1;M.style.display='none';initAudio();return;}
if(state===2&&crashT>1.5){resetGame();return;}
touching=true;var t=tpos(e);touchX=t.x;touchY=t.y;
}
function onM(e){e.preventDefault();if(!touching)return;var t=tpos(e);touchX=t.x;touchY=t.y;}
function onU(e){e.preventDefault();touching=false;}
document.addEventListener('touchstart',onD,{passive:false});
document.addEventListener('touchmove',onM,{passive:false});
document.addEventListener('touchend',onU,{passive:false});
document.addEventListener('mousedown',onD);
document.addEventListener('mousemove',function(e){if(touching){touchX=e.clientX;touchY=e.clientY;}});
document.addEventListener('mouseup',onU);

function resetGame(){
px=0;py=80;pz=0;pitch=0;yaw=0;roll=0;
speed=40;score=0;dist=0;streak=0;mult=1;crashT=0;gameTime=0;
collectFlash=0;shakeX=0;shakeY=0;hp=3;invT=0;
pProjs=[];shootCD=0;aimTarget=-1;
state=1;M.style.display='none';
initBals();
if(eG)eG.gain.value=0.1;
if(wG)wG.gain.value=0.03;
}

// === UPDATE ===
var warnTimer=0;
function update(dt){
if(state!==1)return;
gameTime+=dt;
collectFlash=Math.max(0,collectFlash-dt*3);

// Input
if(touching){
var dx=(touchX-W/2)/(W/2);
var dy=(touchY-Ht/2)/(Ht/2);
var dead=0.05;
var ax=Math.abs(dx)>dead?(dx>0?dx-dead:dx+dead):0;
var ay=Math.abs(dy)>dead?(dy>0?dy-dead:dy+dead):0;
// Smooth exponential approach
var targetRoll=-ax*1.5;
var targetPitch=ay*1.0;
roll+=(targetRoll-roll)*Math.min(3.5*dt,1);
pitch+=(targetPitch-pitch)*Math.min(2.5*dt,1);
}else{
roll+=-roll*Math.min(4*dt,1);
pitch+=-pitch*Math.min(3*dt,1);
}
pitch=Math.max(-1.0,Math.min(1.0,pitch));
roll=Math.max(-1.3,Math.min(1.3,roll));
yaw+=roll*1.0*dt;

speed=45+dist*0.002;
if(speed>120)speed=120;

var fx=-Math.sin(yaw)*Math.cos(pitch);
var fy=Math.sin(pitch);
var fz=-Math.cos(yaw)*Math.cos(pitch);
px+=fx*speed*dt;
py+=fy*speed*dt;
pz+=fz*speed*dt;

// Gravity & lift
var grav=10*dt*0.45;
py-=grav;
var lev=1-Math.abs(pitch)*0.7-Math.abs(roll)*0.25;
if(lev>0)py+=grav*lev;

// Altitude check
var th=ter(px,pz);
var alt=py-th;

// Low altitude warning
warnTimer-=dt;
if(alt<15&&alt>2&&warnTimer<=0){sfxWarn();warnTimer=0.5;}

// Crash
if(alt<2){
state=2;crashT=0;sfxCrash();
if(score>bestScore)bestScore=score;
shakeX=3;shakeY=3;
M.innerHTML='<h1>CRASHED!</h1><div class="s">Score: '+score+'</div><div class="s">Distance: '+Math.floor(dist)+'m</div>'+(bestScore>0?'<p style="color:#f90">Best: '+bestScore+'</p>':'')+'<p style="margin-top:.5em">Tap to restart</p>';
M.style.display='flex';
if(eG){eG.gain.value=0;wG.gain.value=0;}
return;
}

dist+=speed*dt;

// Audio modulation
if(eo1){
var sf=speed/80;
eo1.frequency.value=50+sf*50;
eo2.frequency.value=78+sf*70;
eG.gain.value=0.05+sf*0.06;
wG.gain.value=0.015+sf*0.04;
}

// Screen shake decay
shakeX*=Math.pow(0.01,dt);shakeY*=Math.pow(0.01,dt);

// Spawn balloons
while(bals.length<BCOUNT)spawnBal();
for(var i=bals.length-1;i>=0;i--){
var b=bals[i];
b.st-=dt;
if(b.st<=0){
b.st=2.2+Math.random()*1.5;
var ddx=px-b.x,ddy=py-b.y-4,ddz=pz-b.z;
var ddl=1/Math.sqrt(ddx*ddx+ddy*ddy+ddz*ddz+.001);
var ps=65;
projs.push({x:b.x,y:b.y+4,z:b.z,vx:ddx*ddl*ps,vy:ddy*ddl*ps,vz:ddz*ddl*ps,life:4.5});
sfxShoot();
}
var beh=Math.sin(yaw)*(b.x-px)+Math.cos(yaw)*(b.z-pz);
if(beh>220){gl.deleteBuffer(b.m.buf);bals.splice(i,1);}
}
// Projectiles
invT=Math.max(0,invT-dt);
for(var i=projs.length-1;i>=0;i--){
var pr=projs[i];
pr.x+=pr.vx*dt;pr.y+=pr.vy*dt;pr.z+=pr.vz*dt;
pr.life-=dt;
if(pr.life<=0){projs.splice(i,1);continue;}
if(invT<=0){
var hx=px-pr.x,hy=py-pr.y,hz=pz-pr.z;
if(hx*hx+hy*hy+hz*hz<36){
hp--;invT=1.5;shakeX=2;shakeY=2;sfxHit();streak=0;mult=1;projs.splice(i,1);
if(hp<=0){
state=2;crashT=0;sfxCrash();
if(score>bestScore)bestScore=score;
M.innerHTML='<h1>SHOT DOWN!</h1><div class="s">Score: '+score+'</div><div class="s">Distance: '+Math.floor(dist)+'m</div>'+(bestScore>0?'<p style="color:#f90">Best: '+bestScore+'</p>':'')+'<p style="margin-top:.5em">Tap to restart</p>';
M.style.display='flex';
if(eG){eG.gain.value=0;wG.gain.value=0;}
return;}
}}}

// Auto-aim + shoot at balloons
shootCD=Math.max(0,shootCD-dt);
aimTarget=-1;
var bestDot=-1;
for(var i=0;i<bals.length;i++){
var b=bals[i];
var adx=b.x-px,ady=b.y+4-py,adz=b.z-pz;
var adl=1/Math.sqrt(adx*adx+ady*ady+adz*adz+.001);
var dot=-(adx*adl*Math.sin(yaw)*Math.cos(pitch))+ady*adl*Math.sin(pitch)+-(adz*adl*Math.cos(yaw)*Math.cos(pitch));
if(dot>0.94&&dot>bestDot){bestDot=dot;aimTarget=i;}
}
if(aimTarget>=0&&shootCD<=0&&pProjs.length<MAXPP){
shootCD=0.25;
var tb=bals[aimTarget];
var sdx=tb.x-px,sdy=tb.y+4-py,sdz=tb.z-pz;
var sdl=1/Math.sqrt(sdx*sdx+sdy*sdy+sdz*sdz+.001);
var ps=130;
pProjs.push({x:px+fx*5,y:py,z:pz+fz*5,vx:sdx*sdl*ps,vy:sdy*sdl*ps,vz:sdz*sdl*ps,life:3});
sfxPShoot();
}
// Player projectiles
for(var i=pProjs.length-1;i>=0;i--){
var pp=pProjs[i];
pp.x+=pp.vx*dt;pp.y+=pp.vy*dt;pp.z+=pp.vz*dt;
pp.life-=dt;
if(pp.life<=0){pProjs.splice(i,1);continue;}
for(var bi=bals.length-1;bi>=0;bi--){
var bb=bals[bi];
var hx=pp.x-bb.x,hy=pp.y-bb.y-4,hz=pp.z-bb.z;
if(hx*hx+hy*hy+hz*hz<30){
gl.deleteBuffer(bb.m.buf);bals.splice(bi,1);
pProjs.splice(i,1);
streak++;mult=Math.min(1+Math.floor(streak/2),8);
score+=200*mult;sfxBoom();shakeX=1.2;shakeY=1.2;collectFlash=0.5;
if(aimTarget>=bi)aimTarget=-1;
break;
}}}

// Smooth camera - 3rd person
var cd=22;
var tcx=px-fx*cd,tcy=py-fy*cd+7,tcz=pz-fz*cd;
camX+=(tcx-camX)*Math.min(5*dt,1);
camY+=(tcy-camY)*Math.min(3.5*dt,1);
camZ+=(tcz-camZ)*Math.min(5*dt,1);
}

// === HUD ===
function drawHUD(){
hc.clearRect(0,0,W,Ht);
if(state!==1)return;
hc.save();

// Collect flash overlay
if(collectFlash>0){
hc.fillStyle='rgba(255,220,50,'+collectFlash*0.15+')';
hc.fillRect(0,0,W,Ht);
}

// Low alt warning
var alt=Math.max(0,py-ter(px,pz));
if(alt<15){
var wa=Math.sin(gameTime*8)*0.3+0.3;
hc.fillStyle='rgba(255,40,20,'+wa*(1-alt/15)*0.2+')';
hc.fillRect(0,0,W,Ht);
}

hc.shadowColor='rgba(0,0,0,0.6)';hc.shadowBlur=4;

// Speed
hc.fillStyle='#fff';hc.font='bold 15px sans-serif';hc.textAlign='left';
hc.fillText('SPD '+Math.floor(speed),12,28);

// Altitude
var altI=Math.floor(alt);
hc.textAlign='right';
hc.fillStyle=alt<15?'#f44':'#fff';
hc.fillText('ALT '+altI+'m',W-12,28);

// Score
hc.textAlign='center';
hc.font='bold 24px sans-serif';
hc.fillStyle=collectFlash>0?'#fff':'#fd0';
var sc=collectFlash>0?1+collectFlash*0.15:1;
hc.save();
hc.translate(W/2,26);
hc.scale(sc,sc);
hc.fillText(score,0,0);
hc.restore();

// Multiplier
if(mult>1){
hc.font='bold 15px sans-serif';
var mCols=['','','#0f0','#4df','#f4f','#fa0','#f44','#f0f','#ff0'];
hc.fillStyle=mCols[mult]||'#fd0';
hc.fillText('x'+mult+' STREAK',W/2,48);
}

// Distance
hc.font='12px sans-serif';hc.fillStyle='rgba(255,255,255,0.45)';
hc.fillText(Math.floor(dist)+'m',W/2,Ht-12);

// Health
hc.textAlign='left';hc.font='bold 14px sans-serif';
hc.fillStyle='#fff';hc.fillText('HP',12,Ht-18);
for(var hi=0;hi<3;hi++){
hc.fillStyle=hi<hp?(invT>0&&Math.sin(gameTime*12)>0?'#f88':'#f33'):'rgba(255,255,255,0.15)';
hc.fillRect(34+hi*18,Ht-28,14,14);
}
// Hit flash
if(invT>0.8){
hc.fillStyle='rgba(255,30,10,'+(invT-0.8)*0.4+')';
hc.fillRect(0,0,W,Ht);
}

// Crosshair
hc.shadowBlur=0;
var aimed=aimTarget>=0;
hc.strokeStyle=aimed?'rgba(255,60,30,0.9)':'rgba(255,255,255,0.3)';
hc.lineWidth=aimed?2.5:1.5;
var cx=W/2,cy=Ht/2,cr=aimed?12:8;
hc.beginPath();hc.arc(cx,cy,cr,0,6.2832);hc.stroke();
if(aimed){
hc.beginPath();hc.arc(cx,cy,cr+6,0,6.2832);hc.stroke();
hc.fillStyle='rgba(255,60,30,0.15)';
hc.beginPath();hc.arc(cx,cy,cr+6,0,6.2832);hc.fill();
}
hc.beginPath();
var cl=aimed?20:16,ci=aimed?12:10;
hc.moveTo(cx-cl,cy);hc.lineTo(cx-ci,cy);
hc.moveTo(cx+ci,cy);hc.lineTo(cx+cl,cy);
hc.moveTo(cx,cy-cl);hc.lineTo(cx,cy-ci);
hc.moveTo(cx,cy+ci);hc.lineTo(cx,cy+cl);
hc.stroke();

// Vignette
var vr=Math.max(W,Ht)*0.75;
var vg=hc.createRadialGradient(W/2,Ht/2,vr*0.35,W/2,Ht/2,vr);
vg.addColorStop(0,'rgba(0,0,0,0)');
vg.addColorStop(1,'rgba(0,0,0,0.35)');
hc.fillStyle=vg;
hc.fillRect(0,0,W,Ht);

hc.restore();
}

// === RENDER ===
function render(){
var t=performance.now()/1000;
var skyR=0.85,skyG=0.75,skyB=0.6;

gl.clear(gl.DEPTH_BUFFER_BIT);
// Sky gradient
gl.disable(gl.DEPTH_TEST);
gl.useProgram(skProg);
gl.bindBuffer(gl.ARRAY_BUFFER,skBuf);
gl.enableVertexAttribArray(skAP);
gl.vertexAttribPointer(skAP,2,gl.FLOAT,false,0,0);
gl.drawArrays(gl.TRIANGLES,0,3);
gl.disableVertexAttribArray(skAP);
gl.enable(gl.DEPTH_TEST);

buildTerrain(px,pz);

var proj=perspective(1.0,W/Ht,1,500);
var fx=-Math.sin(yaw)*Math.cos(pitch);
var fy=Math.sin(pitch);
var fz=-Math.cos(yaw)*Math.cos(pitch);
// Look at a point ahead of the player
var clx=px+fx*20,cly=py+fy*20,clz=pz+fz*20;

// Add shake
var sex=camX+(Math.random()-0.5)*shakeX;
var sey=camY+(Math.random()-0.5)*shakeY;
var sez=camZ+(Math.random()-0.5)*shakeX;

var view=lookAtMat(sex,sey,sez,clx,cly,clz,roll*0.6);
var vp=mulM(proj,view);

// Draw terrain
gl.useProgram(prog);
gl.uniformMatrix4fv(uVP,false,vp);
gl.uniform3f(uCam,camX,camY,camZ);
gl.uniform3f(uSky,skyR,skyG,skyB);
gl.uniform1f(uTime,t);

var stride=36;
gl.bindBuffer(gl.ARRAY_BUFFER,tBuf);
gl.enableVertexAttribArray(lP);
gl.vertexAttribPointer(lP,3,gl.FLOAT,false,stride,0);
gl.enableVertexAttribArray(lC);
gl.vertexAttribPointer(lC,3,gl.FLOAT,false,stride,12);
gl.enableVertexAttribArray(lN);
gl.vertexAttribPointer(lN,3,gl.FLOAT,false,stride,24);
gl.drawArrays(gl.TRIANGLES,0,triCount);

// Draw objects
gl.useProgram(rProg);
gl.uniformMatrix4fv(ruVP,false,vp);
gl.uniform3f(ruCam,camX,camY,camZ);
gl.uniform3f(ruSky,skyR,skyG,skyB);
gl.disableVertexAttribArray(lC);
gl.disableVertexAttribArray(lN);

// Draw balloons
for(var i=0;i<bals.length;i++){
var b=bals[i];
gl.uniform3f(ruCol,b.c[0],b.c[1],b.c[2]);
gl.bindBuffer(gl.ARRAY_BUFFER,b.m.buf);
gl.enableVertexAttribArray(rlP);
gl.vertexAttribPointer(rlP,3,gl.FLOAT,false,24,0);
gl.enableVertexAttribArray(rlN);
gl.vertexAttribPointer(rlN,3,gl.FLOAT,false,24,12);
gl.drawArrays(gl.TRIANGLES,0,b.m.cnt);
}
// Draw projectiles
if(projs.length>0){
var pjCnt=buildProjBuf();
gl.uniform3f(ruCol,1.0,0.25,0.05);
gl.bindBuffer(gl.ARRAY_BUFFER,pjBuf);
gl.enableVertexAttribArray(rlP);
gl.vertexAttribPointer(rlP,3,gl.FLOAT,false,24,0);
gl.enableVertexAttribArray(rlN);
gl.vertexAttribPointer(rlN,3,gl.FLOAT,false,24,12);
gl.drawArrays(gl.TRIANGLES,0,pjCnt);
}

// Draw player projectiles
if(pProjs.length>0){
var ppCnt=buildPPBuf();
gl.uniform3f(ruCol,0.2,0.85,1.0);
gl.bindBuffer(gl.ARRAY_BUFFER,ppBuf);
gl.enableVertexAttribArray(rlP);
gl.vertexAttribPointer(rlP,3,gl.FLOAT,false,24,0);
gl.enableVertexAttribArray(rlN);
gl.vertexAttribPointer(rlN,3,gl.FLOAT,false,24,12);
gl.drawArrays(gl.TRIANGLES,0,ppCnt);
}

// Draw plane
if(state===1&&!(invT>0&&Math.sin(gameTime*20)>0)){
updatePlane(px,py,pz,pitch,yaw,roll);
var plR=invT>0?1.0:0.92,plG=invT>0?0.4:0.94,plB=invT>0?0.3:0.96;
gl.uniform3f(ruCol,plR,plG,plB);
gl.bindBuffer(gl.ARRAY_BUFFER,plBuf);
gl.enableVertexAttribArray(rlP);
gl.vertexAttribPointer(rlP,3,gl.FLOAT,false,24,0);
gl.enableVertexAttribArray(rlN);
gl.vertexAttribPointer(rlN,3,gl.FLOAT,false,24,12);
gl.drawArrays(gl.TRIANGLES,0,plCount);
}

drawHUD();
}

// === LOOP ===
function loop(t){
var dt=Math.min((t-lastT)/1000,0.05);
lastT=t;
if(state===2){crashT+=dt;shakeX*=Math.pow(0.001,dt);shakeY*=Math.pow(0.001,dt);}
update(dt);
render();
requestAnimationFrame(loop);
}

buildTerrain(0,0);
lastT=performance.now();
requestAnimationFrame(loop);
</script>
</body>
</html>
